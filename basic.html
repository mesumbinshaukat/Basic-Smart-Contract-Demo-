<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basic Smart-Contract</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body class="bg-dark">

    <h1 class="text-center text-light">Basic Smart-Contract</h1>
    <p class="text-end"><button class="btn btn-warning m-3" id="connect">Connect Wallet</button></p>
    <hr style="background-color: aliceblue !important;">


    <div class="container-fluid text-center">
        <div class="row">
            <div class="col-6">
                <div class="container text-center">

                    <div class="row d-flex justify-content-center">
                        <div class="col-lg-12 text-center">
                            <div class="mb-5 w-100 text-center mx-auto">
                                <label class="form-label text-light">Deposit Amount</label>
                                <input type="int" class="form-control" placeholder="Deposit" id="dep" required>
                                <button type="submit" id="depBtn" class="btn btn-success mt-4">Deposit</button>
                            </div>
                        </div>
                        <div class="col-lg-12 text-center">
                            <div class="mb-3 w-100 text-center mx-auto">
                                <label class="form-label text-light">Product 1</label>
                                <input type="text" class="form-control" id="p1" placeholder="Product 1" required>
                            </div>
                            <div class="mb-3 w-100 text-center mx-auto">
                                <label class="form-label text-light">Product 2</label>
                                <input type="text" class="form-control" id="p2" placeholder="Product 2" required>
                            </div>
                            <div class="mb-3 w-100 text-center mx-auto">
                                <label class="form-label text-light">Product 3</label>
                                <input type="text" class="form-control" id="p3" placeholder="Product 3" required>
                            </div>
                            <button type="submit" id="addProduct" class="btn btn-outline-light mt-4">Add
                                Product</button>
                        </div>
                    </div>


                </div>
            </div>

            <div class="col-6">
                <div class="container text-center">
                    <form>
                        <div class="row d-flex justify-content-center">
                            <div class="col-lg-12 text-center">
                                <div class="mb-5 w-100 text-center mx-auto">
                                    <label class="form-label text-light">Current Balance</label>
                                    <input type="int" id="currBal" class="form-control" placeholder="Current Balance"
                                        disabled>

                                </div>
                            </div>
                            <div class="col-lg-12 text-center">
                                <div class="mb-3 w-100 text-center mx-auto">
                                    <label class="form-label text-light">Account Limit</label>
                                    <input type="int" class="form-control" placeholder="Account Limit" id="limit"
                                        value="" disabled>
                                </div>

                            </div>
                            <div class="col-lg-12 text-center">
                                <div class="mb-3 w-100 text-center mx-auto">
                                    <label class="form-label text-light">Products</label>
                                    <input type="Text" class="form-control" placeholder="Products" value=""
                                        id="products" disabled>
                                </div>

                            </div>
                        </div>

                    </form>
                </div>
            </div>

        </div>

    </div>


    <script src="./node_modules/web3/dist/web3.min.js"></script>

    <script>
        var web3 = new Web3(window.ethereum)

        let contract

        const contractAddress = '0x2BA762a2124B121Da94a6817cbb4580607Df159c';

        const abi = [
            {
                "inputs": [
                    {
                        "internalType": "int256",
                        "name": "dep",
                        "type": "int256"
                    }
                ],
                "name": "depositAmount",
                "outputs": [
                    {
                        "internalType": "int256",
                        "name": "bal",
                        "type": "int256"
                    },
                    {
                        "internalType": "string",
                        "name": "err",
                        "type": "string"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "p1",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "p2",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "p3",
                        "type": "string"
                    }
                ],
                "name": "productList",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "inputs": [],
                "name": "checkAccountLimit",
                "outputs": [
                    {
                        "internalType": "int256",
                        "name": "",
                        "type": "int256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "checkBalance",
                "outputs": [
                    {
                        "internalType": "int256",
                        "name": "",
                        "type": "int256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "displayProducts",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ]

        contract = new web3.eth.Contract(abi, contractAddress)


        const depBtn = document.querySelector('#depBtn')

        const connectWallet = document.querySelector("#connect")

        const addProducts = document.querySelector("#addProduct")

        let accounts = [];

        depBtn.addEventListener("click", () => {
            let depInEther = parseFloat(document.getElementById("dep").value);
            let depInWei = web3.utils.toWei(depInEther.toString(), 'ether');
            console.log(dep)
            window.ethereum.request({
                "method": "eth_sendTransaction",
                "params": [
                    {
                        "from": accounts[0],
                        "to": "0x1fc6aAc8c04E5aBb53dFF2D1845Ef1030AE9287A",
                        "value": depInWei,
                        "gasLimit": "500000"
                    },
                ],
            })
                .then((txHash) => {
                    console.log("SUCCESS")
                    console.log(txHash);
                })
                .catch((error) => {
                    console.log("ERROR")
                    console.log(error);
                })

            web3.eth.getAccounts().then(function (accounts) {
                var acc = accounts[0];
                return contract.methods.depositAmount(depInWei).send({
                    from: acc
                });
            })


        })

        async function updateBalance() {
            const balance = await contract.methods.checkBalance().call({ from: accounts[0] });
            document.querySelector("#currBal").value = balance;
            console.log(balance);
        }

        async function accountLimit() {
            const limit = await contract.methods.checkAccountLimit().call({ from: accounts[0] })
            document.querySelector("#limit").value = limit;
            console.log(limit);
        }

        async function displayProducts() {
            const products = await contract.methods.displayProducts().call({ from: accounts[0] })
            document.querySelector("#products").value = products;
            console.log(products)
        }

        connectWallet.addEventListener("click", async () => {
            await connect();
            updateBalance();
            accountLimit();
            displayProducts();
        });


        async function connect() {
            accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            console.log(accounts);
        }

        addProducts.addEventListener("click", () => {
            let p1 = document.getElementById("p1").value;
            let p2 = document.getElementById("p2").value;
            let p3 = document.getElementById("p3").value;
            contract.methods.productList(p1, p2, p3).send({ from: accounts[0] });
        });





    </script>
</body>

</html>